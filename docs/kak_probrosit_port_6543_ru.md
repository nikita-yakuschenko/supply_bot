# Как пробросить порт 6543 с Supabase, чтобы бот подключился к базе

Бот и Supabase у тебя на одном VPS. Бот крутится в своём контейнере и должен подключаться к базе по адресу **172.17.0.1:6543**. Чтобы это работало, порт **6543** с контейнера Supabase (pooler) должен быть «проброшен» на хост. Ниже — куда зайти и что сделать.

---

## Шаг 1. Зайти в Dokploy

1. Открой в браузере адрес Dokploy (тот, где ты заходишь в панель).
2. Войди в аккаунт.
3. Выбери **проект**, в котором развёрнут **Supabase** (не бот).

---

## Шаг 2. Открыть приложение Supabase

1. В списке приложений найди приложение **Supabase** (то, где база и pooler).
2. Нажми на него, чтобы открыть карточку приложения.

---

## Шаг 3. Найти настройки портов / Docker Compose

В Dokploy у приложения обычно есть:

- вкладка **«Compose»** или **«Docker Compose»** — там показывается или редактируется `docker-compose`,
- либо раздел **«Ports» / «Порты»** у конкретного сервиса.

Нужно сделать так, чтобы у сервиса, который слушает порт **6543** (pooler / supavisor / postgres pooler), этот порт был **опубликован на хост**.

---

## Вариант А. Есть кнопка «Ports» / «Порты» у сервиса

1. В приложении Supabase открой список **сервисов** (контейнеров).
2. Найди сервис с названием вроде **pooler**, **supavisor**, **db-pooler** или **supabase-db** (тот, у которого порт 6543).
3. Открой настройки этого сервиса.
4. Если есть поле **«Ports»** / **«Порты»** / **«Expose»**:
   - добавь проброс порта: **6543** → **6543**  
   (часто вводят в формате `6543:6543` или «Host port: 6543, Container port: 6543»).
5. Сохрани настройки и сделай **Redeploy** приложения Supabase (чтобы контейнеры пересоздались с новым портом).

---

## Вариант Б. Редактируешь сам YAML (docker-compose) — твой случай

У тебя порт 6543 уже проброшен у сервиса **supavisor**, но только на **127.0.0.1**. Контейнер бота подключается с **172.17.0.1**, поэтому соединение не доходит. Нужно слушать на всех интерфейсах.

1. Открой в Dokploy приложение Supabase и вкладку с **docker-compose** (где редактируется YAML).
2. Найди блок **supavisor** (он же pooler). В нём секция **ports** выглядит так:

```yaml
supavisor:
  ...
  ports:
    - "127.0.0.1:${POSTGRES_PORT}:5432"
    - "127.0.0.1:${POOLER_PROXY_PORT_TRANSACTION}:6543"
```

3. Замени **вторую** строку портов: вместо `127.0.0.1` укажи **0.0.0.0** (или убери `127.0.0.1:`):

**Было:**
```yaml
    - "127.0.0.1:${POOLER_PROXY_PORT_TRANSACTION}:6543"
```

**Стало:**
```yaml
    - "0.0.0.0:${POOLER_PROXY_PORT_TRANSACTION}:6543"
```

Или можно просто (порт на хосте = 6543):
```yaml
    - "6543:6543"
```

Первая строка (5432) можешь оставить с `127.0.0.1`, менять только строку с **6543**.

4. Сохрани compose и сделай **Redeploy** приложения Supabase.

---

## Шаг 4. Проверить, что порт открыт

После редеплоя Supabase подожди 1–2 минуты, потом на самом VPS (по SSH или через терминал в панели) выполни:

```bash
curl -v telnet://127.0.0.1:6543
```

или (на Windows PowerShell с того же сервера, если бот на Windows не стоит):

```powershell
Test-NetConnection -ComputerName 127.0.0.1 -Port 6543
```

Если порт открыт, соединение не будет сразу «refused». Тогда бот с `DATABASE_URL` на **172.17.0.1:6543** сможет достучаться до базы.

---

## Шаг 5. Переменные бота на сервере

В настройках **бота** в Dokploy в переменных окружения должно быть примерно так (без `https://` в адресе):

```env
DATABASE_URL=postgresql://postgres.ТВОЙ_TENANT_ID:ПАРОЛЬ@172.17.0.1:6543/postgres
```

- **ТВОЙ_TENANT_ID** — подставь свой tenant (не буквально `your-tenant-id`).
- **ПАРОЛЬ** — пароль от БД. Если в пароле есть символы `@` или `?`, замени их на `%40` и `%3F`.

После сохранения переменных сделай **Redeploy бота**.

---

## Если не получается найти сервис с портом 6543

В Supabase self-hosted порт 6543 обычно слушает сервис **Supavisor** (pooler). В полном compose от Supabase ищи блок с именем **supavisor** или **pooler** и добавляй ему `ports: - "6543:6543"` как в варианте Б выше.

Если напишешь, в какой панели ты работаешь (только Dokploy или ещё что-то) и как называется приложение Supabase, можно расписать ещё точнее под твой экран.
